<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.19.3 by Michael Rose
  Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="ko" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Annotation Attribute Value 변경하기 - happl’s Doodle</title>
<meta name="description" content="최근 개발을 진행하면서 Custom Annotation을 활용하게 되었는데, Annotation Attribute 값에 System Property Key를 지정하여 해당 값을 가져와 Annotation의 다른 Attribute에 주입해야만 하는 일이 생겼다.">


  <meta name="author" content="Yoonseong JI">


<meta property="og:type" content="article">
<meta property="og:locale" content="ko_KR">
<meta property="og:site_name" content="happl's Doodle">
<meta property="og:title" content="Annotation Attribute Value 변경하기">
<meta property="og:url" content="https://ysjee141.github.io/blog/spring/AnnotationAttributeInjection/">


  <meta property="og:description" content="최근 개발을 진행하면서 Custom Annotation을 활용하게 되었는데, Annotation Attribute 값에 System Property Key를 지정하여 해당 값을 가져와 Annotation의 다른 Attribute에 주입해야만 하는 일이 생겼다.">







  <meta property="article:published_time" content="2021-07-07T00:00:00+00:00">





  

  


<link rel="canonical" href="https://ysjee141.github.io/blog/spring/AnnotationAttributeInjection/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "happl",
      "url": "https://ysjee141.github.io/blog/"
    
  }
</script>






<!-- end _includes/seo.html -->


<link href="/blog/feed.xml" type="application/atom+xml" rel="alternate" title="happl's Doodle Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/blog/assets/css/main.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css">
<link rel="stylesheet" href="/blog/assets/css/syntax.css">

<!--[if IE]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->


  
    <script src="/blog/assets/js/vendor/jquery/jquery-3.4.1.js"></script>
  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.16.0/axios.min.js"></script>
  
    <script src="https://unpkg.com/turndown/dist/turndown.js"></script>
  
    <script src="https://unpkg.com/turndown-plugin-gfm/dist/turndown-plugin-gfm.js"></script>
  
    <script src="/blog/assets/js/vendor/bluebird.js"></script>
  


    <!-- start custom head snippets -->
<meta name="google-site-verification" content="SO-0QxMtMMEgiaV3K59vtKNi2ucxcYXH9gROvXDOke0" />
<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single wide">
    <nav class="skip-links">
  <h2 class="screen-reader-text">Skip links</h2>
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/blog/">
          happl's Doodle
          <span class="site-subtitle">심심해서 끄적거리는 낙서장</span>
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              
              <a data-link="Blog" href="/blog/">Blog</a>
            </li><li class="masthead__menu-item">
              
              <a data-link="Tag" href="/blog/tag">Tag</a>
            </li><li class="masthead__menu-item">
              
              <a data-link="Repos" href="/blog/github-repos">Repos</a>
            </li><li class="masthead__menu-item">
              
              <a data-link="About" href="/blog/about">About</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <svg class="icon" width="16" height="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 15.99 16">
            <path d="M15.5,13.12L13.19,10.8a1.69,1.69,0,0,0-1.28-.55l-0.06-.06A6.5,6.5,0,0,0,5.77,0,6.5,6.5,0,0,0,2.46,11.59a6.47,6.47,0,0,0,7.74.26l0.05,0.05a1.65,1.65,0,0,0,.5,1.24l2.38,2.38A1.68,1.68,0,0,0,15.5,13.12ZM6.4,2A4.41,4.41,0,1,1,2,6.4,4.43,4.43,0,0,1,6.4,2Z" transform="translate(-.01)"></path>
          </svg>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">토글 메뉴</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>

<script>
  $(document).ready(function() {

    var _url = window.location.pathname;

    if( _url.indexOf("/tag") > -1 ) {
      $("[data-link='Tag']").addClass("hover");
    } else if( _url.indexOf("/github-repos") > -1 ) {
      $("[data-link='Repos']").addClass("hover");
    } else if( _url.indexOf("/about") > -1 ) {
      $("[data-link='About']").addClass("hover");
    } else {
      $("[data-link='Blog']").addClass("hover");
    }


  })
</script>

    <div class="initial-content">
      


<!--<button type="button" onclick="slideshow('/blog/spring/AnnotationAttributeInjection/')">Slide</button>-->
<!-- SlideShow Information -->

<textarea id="source" style="display: none">최근 개발을 진행하면서 Custom Annotation을 활용하게 되었는데, Annotation Attribute 값에 System Property Key를 지정하여
해당 값을 가져와 Annotation의 다른 Attribute에 주입해야만 하는 일이 생겼다.

확인해보니 Annotation Attribute에 값을 지정하기 위해서는 @Value Annotation과 같은 Annotation의 사용이 불가능하고,
직접 값을 주입하거나 상수(final) 값만이 지정이 가능해서 난감했다.

이러저러한 방법을 찾던 도중 InvocationHandle을 통해 Proxy 패턴으로 값을 주입할 수 있었다.
이를 위해서 BeanPostProcessor를 통해 Handler를 구현하여 처리가 가능했고, 그 내용을 아래와 같이 공유한다.

Spring 을 사용하다보면 필연적으로 IoC와 DI란 용어를 접하게 된다.
그러나 IoC와 DI를 제대로 이해하고 사용하는가에 대해 물어본다면 사실 그렇지 않다라고 대부분의 개발자는 이야기할 것이다.
본 포스트에서는 이러한 Spring 의 IoC와 DI의 개념과 동작방식을 설명하고자 한다.

### 완성 코드
```java
@Component
public class EntWrapperServiceAnnotationHandler implements BeanPostProcessor {

  private final Environment environment;

  public EntWrapperServiceAnnotationHandler(Environment environment) {
    this.environment = environment;
  }

  @Override
  public Object postProcessBeforeInitialization(Object bean,
      @SuppressWarnings("NullableProblems") String beanName)
      throws BeansException {

    // BeanPostProcessor 는 모든 Bean 이 생성될 때 호출되기 때문에
    // EntWrapperService Type Annotation 및 상위 클래스가 BaseWrapper 인 경우에만 수행되도록 조건 처리
    if (bean.getClass().isAnnotationPresent(EntWrapperService.class)
        && bean.getClass().getSuperclass().equals(BaseWrapper.class)) {
      try {
        EntWrapperService annotation = bean.getClass().getAnnotation(EntWrapperService.class);

        // prefix 값이 비어 있는 경우 수행하지 않음
        if (!annotation.prefix().equals("")) {
          EntWrapperServicePropertyHolder holder = Binder.get(environment)
              .bind(annotation.prefix(), EntWrapperServicePropertyHolder.class)
              .orElse(null);

          if (holder != null) {
            // Annotation Attribute 값을 변경하기 위해 Proxy 를 통한 Invocation 처리
            InvocationHandler invocationHandler = Proxy.getInvocationHandler(annotation);
            Field f = invocationHandler.getClass().getDeclaredField("memberValues");
            f.setAccessible(true);
            //noinspection unchecked
            holder.setToAnnotation((Map<String, Object>) f.get(invocationHandler));

            // Bean Lifecycle 혼선 방지를 위해 Annotation Attribute 값 변경 후 직접 Bean Init 수행
            // 상위 클래스인 BaseWrapper#init() Invoking 을 위해 Lookup 사용
            MethodHandles.privateLookupIn(bean.getClass(), MethodHandles.lookup())
                .in(bean.getClass())
                .findSpecial(BaseWrapper.class, "init",
                    MethodType.methodType(void.class), bean.getClass())
                .invoke(bean);
          } else {
            throw new Exception("ddd");
          }
        }
      } catch (Throwable e) {
        e.printStackTrace();
      }
    }
    return BeanPostProcessor.super.postProcessBeforeInitialization(bean, beanName);
  }
}
```

BeanPostProcessor 는 서비스 구동시 선언된 모든 Bean이 생성될 때 마다 호출이 된다.
때문에 반드시 필요한 Bean 형식인 경우에 한하여 구동하도록 조건을 걸도록 한다. 이번에는 EntWrapperService 라는 Annotation이 선언되었으며
BaseWrapper 클래스를 상속받은 Bean에 한정하여 구동되도록 조건을 걸어 두었다.
```java
if (bean.getClass().isAnnotationPresent(EntWrapperService.class)
        && bean.getClass().getSuperclass().equals(BaseWrapper.class)) { }
```

Annotation Attribute 값을 주입하기 위해서는 직접 주입이 불가능하고, Proxy 패턴을 활용하여
Invocation 처리하는 것이 필요하다. 이를 위한 코드는 아래와 같다.
```java
EntWrapperService annotation = bean.getClass().getAnnotation(EntWrapperService.class);

InvocationHandler invocationHandler = Proxy.getInvocationHandler(annotation);
Field f = invocationHandler.getClass().getDeclaredField("memberValues");
f.setAccessible(true);
Map<String, Object> values = (Map<String, Object>) f.get(invocationHandler);
String newValue = "newValue";
values.put("baseUrl", newValue);
```

Proxy.getInvocationHandler() 를 통해 값을 변경하려는 대상 Object에 대한 InvocationHandler를 생성한다. 
이후 생성된 InvocationHandler를 값을 변경하면 되는데, Annotation 타입의 경우 Attribute 값이 Map<String, Object> 형식의
memberValues 필드에 값이 저장되어 있다. 따라서 해당 필드를 가져와 값을 변경하여 주면 원본 Instance의 값이 변경된다.
이는 JDK에서 제공하는 Proxy 클래스를 통해서 원본 객체를 바꿔주는 방식이다. JDK는 이러한 과정을 Proxy 클래스를 통한 Proxy 패턴을 구현하여 준다.
추가적으로 설명을 하자면, Proxy.getInvocationHandler()를 통해 생성된 InvocationHandler를 활용하면, 기존에 선언된
Method의 동작에 추가 동작을 주입하는 것도 가능하다. 이 부분에 대해서는 기회가 되면 포스팅 하도록 하겠다.

이번 작업에서는 새로 주입된 Annotation Attribute 값을 상위 클래스인 BaseWrapper에서 사용해야 하는 경우였다.
BaseWrapper의 경우에는 Bean 형식이 아니기 때문에 직접 생성자를 지정해야하는데 BeanPostProcessor를 통해 Annotation Attribute 값을
주입하다보니, BaseWrapper의 생성 시기와 Annotation Attribute 값이 주입되는 시기가 어긋나는 경우가 발생하였다.
이를 위해서 Annotation Attribute 값 주입이 끝난 후 Reflection을 통해 직접 상위 클래스의 init() Method를 직접 호출하는 방식을
적용하였다. 단, 무분별한 호출을 막기 위해 상위 클래스의 init() Method는 protected 로 선언하였더니 직접적인 invoke가 불가능하였다.
이를 위해 아래의 코드를 통해 private scope 의 Method의 호출에 성공할 수 있었다.
```java
 MethodHandles.privateLookupIn(bean.getClass(), MethodHandles.lookup())
    .in(bean.getClass())
    .findSpecial(BaseWrapper.class, "init",
        MethodType.methodType(void.class), bean.getClass())
    .invoke(bean);
```
이와 같은 코드를 활용하면 마치 상속 받은 클래스에서 상위 클래스의 Method를 호출하는 것과 같은 효과를 볼 수 있다.</textarea>
<!-- // SlideShow Information -->
<div id="main" role="main">
  


  
  <article class="page no-author" itemscope itemtype="https://schema.org/CreativeWork">
  

  <!--<article class="page" itemscope itemtype="https://schema.org/CreativeWork">-->
    <meta itemprop="headline" content="Annotation Attribute Value 변경하기">
    <meta itemprop="description" content="최근 개발을 진행하면서 Custom Annotation을 활용하게 되었는데, Annotation Attribute 값에 System Property Key를 지정하여해당 값을 가져와 Annotation의 다른 Attribute에 주입해야만 하는 일이 생겼다.">
    <meta itemprop="datePublished" content="2021-07-07T00:00:00+00:00">
    

    <div class="page__inner-wrap">
      
        <header style="padding-bottom: 25px;">
          <h1 id="page-title" class="page__title" itemprop="headline">Annotation Attribute Value 변경하기
</h1>
          
            <p class="page__meta">
              <i class="far fa-clock" aria-hidden="true"></i> 2021/07/07
              
              
              
              
              <i class="category__link">in <a href="/blog/category/spring">Spring</a></i>
            </p>
          
        </header>
      
      <span class="page-divider">
        <span class="one"></span>
        <span class="two"></span>
      </span>
      <ul class="page-tag-list">
        <strong><i class="fas fa-fw fa-tags" aria-hidden="true" style="font-size: .7em"></i>
        
        
        <li><a href="/blog/tag/spring">#Spring</a></li>
        
        
        <li><a href="/blog/tag/annotation">#Annotation</a></li>
        
        
        <li><a href="/blog/tag/invocation">#Invocation</a></li>
        
          <a class="page__meta__hits">
            <img src="https://hitcounter.pythonanywhere.com/count/tag.svg?url=ysjee141.github.iospringAnnotationAttributeInjection" alt="Hits">
          </a>
      </ul>

      <section class="page__content" itemprop="text">
        
        <p>최근 개발을 진행하면서 Custom Annotation을 활용하게 되었는데, Annotation Attribute 값에 System Property Key를 지정하여
해당 값을 가져와 Annotation의 다른 Attribute에 주입해야만 하는 일이 생겼다.</p>

<p>확인해보니 Annotation Attribute에 값을 지정하기 위해서는 @Value Annotation과 같은 Annotation의 사용이 불가능하고,
직접 값을 주입하거나 상수(final) 값만이 지정이 가능해서 난감했다.</p>

<p>이러저러한 방법을 찾던 도중 InvocationHandle을 통해 Proxy 패턴으로 값을 주입할 수 있었다.
이를 위해서 BeanPostProcessor를 통해 Handler를 구현하여 처리가 가능했고, 그 내용을 아래와 같이 공유한다.</p>

<p>Spring 을 사용하다보면 필연적으로 IoC와 DI란 용어를 접하게 된다.
그러나 IoC와 DI를 제대로 이해하고 사용하는가에 대해 물어본다면 사실 그렇지 않다라고 대부분의 개발자는 이야기할 것이다.
본 포스트에서는 이러한 Spring 의 IoC와 DI의 개념과 동작방식을 설명하고자 한다.</p>

<h3 id="완성-코드">완성 코드</h3>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">EntWrapperServiceAnnotationHandler</span> <span class="kd">implements</span> <span class="nc">BeanPostProcessor</span> <span class="o">{</span>

  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Environment</span> <span class="n">environment</span><span class="o">;</span>

  <span class="kd">public</span> <span class="nf">EntWrapperServiceAnnotationHandler</span><span class="o">(</span><span class="nc">Environment</span> <span class="n">environment</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">environment</span> <span class="o">=</span> <span class="n">environment</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="nc">Object</span> <span class="nf">postProcessBeforeInitialization</span><span class="o">(</span><span class="nc">Object</span> <span class="n">bean</span><span class="o">,</span>
      <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"NullableProblems"</span><span class="o">)</span> <span class="nc">String</span> <span class="n">beanName</span><span class="o">)</span>
      <span class="kd">throws</span> <span class="nc">BeansException</span> <span class="o">{</span>

    <span class="c1">// BeanPostProcessor 는 모든 Bean 이 생성될 때 호출되기 때문에</span>
    <span class="c1">// EntWrapperService Type Annotation 및 상위 클래스가 BaseWrapper 인 경우에만 수행되도록 조건 처리</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">bean</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">isAnnotationPresent</span><span class="o">(</span><span class="nc">EntWrapperService</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
        <span class="o">&amp;&amp;</span> <span class="n">bean</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getSuperclass</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="nc">BaseWrapper</span><span class="o">.</span><span class="na">class</span><span class="o">))</span> <span class="o">{</span>
      <span class="k">try</span> <span class="o">{</span>
        <span class="nc">EntWrapperService</span> <span class="n">annotation</span> <span class="o">=</span> <span class="n">bean</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getAnnotation</span><span class="o">(</span><span class="nc">EntWrapperService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

        <span class="c1">// prefix 값이 비어 있는 경우 수행하지 않음</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">annotation</span><span class="o">.</span><span class="na">prefix</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="s">""</span><span class="o">))</span> <span class="o">{</span>
          <span class="nc">EntWrapperServicePropertyHolder</span> <span class="n">holder</span> <span class="o">=</span> <span class="nc">Binder</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">environment</span><span class="o">)</span>
              <span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="n">annotation</span><span class="o">.</span><span class="na">prefix</span><span class="o">(),</span> <span class="nc">EntWrapperServicePropertyHolder</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
              <span class="o">.</span><span class="na">orElse</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>

          <span class="k">if</span> <span class="o">(</span><span class="n">holder</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// Annotation Attribute 값을 변경하기 위해 Proxy 를 통한 Invocation 처리</span>
            <span class="nc">InvocationHandler</span> <span class="n">invocationHandler</span> <span class="o">=</span> <span class="nc">Proxy</span><span class="o">.</span><span class="na">getInvocationHandler</span><span class="o">(</span><span class="n">annotation</span><span class="o">);</span>
            <span class="nc">Field</span> <span class="n">f</span> <span class="o">=</span> <span class="n">invocationHandler</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"memberValues"</span><span class="o">);</span>
            <span class="n">f</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
            <span class="c1">//noinspection unchecked</span>
            <span class="n">holder</span><span class="o">.</span><span class="na">setToAnnotation</span><span class="o">((</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;)</span> <span class="n">f</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">invocationHandler</span><span class="o">));</span>

            <span class="c1">// Bean Lifecycle 혼선 방지를 위해 Annotation Attribute 값 변경 후 직접 Bean Init 수행</span>
            <span class="c1">// 상위 클래스인 BaseWrapper#init() Invoking 을 위해 Lookup 사용</span>
            <span class="nc">MethodHandles</span><span class="o">.</span><span class="na">privateLookupIn</span><span class="o">(</span><span class="n">bean</span><span class="o">.</span><span class="na">getClass</span><span class="o">(),</span> <span class="nc">MethodHandles</span><span class="o">.</span><span class="na">lookup</span><span class="o">())</span>
                <span class="o">.</span><span class="na">in</span><span class="o">(</span><span class="n">bean</span><span class="o">.</span><span class="na">getClass</span><span class="o">())</span>
                <span class="o">.</span><span class="na">findSpecial</span><span class="o">(</span><span class="nc">BaseWrapper</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="s">"init"</span><span class="o">,</span>
                    <span class="nc">MethodType</span><span class="o">.</span><span class="na">methodType</span><span class="o">(</span><span class="kt">void</span><span class="o">.</span><span class="na">class</span><span class="o">),</span> <span class="n">bean</span><span class="o">.</span><span class="na">getClass</span><span class="o">())</span>
                <span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">bean</span><span class="o">);</span>
          <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">Exception</span><span class="o">(</span><span class="s">"ddd"</span><span class="o">);</span>
          <span class="o">}</span>
        <span class="o">}</span>
      <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
      <span class="o">}</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="nc">BeanPostProcessor</span><span class="o">.</span><span class="na">super</span><span class="o">.</span><span class="na">postProcessBeforeInitialization</span><span class="o">(</span><span class="n">bean</span><span class="o">,</span> <span class="n">beanName</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>BeanPostProcessor 는 서비스 구동시 선언된 모든 Bean이 생성될 때 마다 호출이 된다.
때문에 반드시 필요한 Bean 형식인 경우에 한하여 구동하도록 조건을 걸도록 한다. 이번에는 EntWrapperService 라는 Annotation이 선언되었으며
BaseWrapper 클래스를 상속받은 Bean에 한정하여 구동되도록 조건을 걸어 두었다.</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="o">(</span><span class="n">bean</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">isAnnotationPresent</span><span class="o">(</span><span class="nc">EntWrapperService</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
        <span class="o">&amp;&amp;</span> <span class="n">bean</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getSuperclass</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="nc">BaseWrapper</span><span class="o">.</span><span class="na">class</span><span class="o">))</span> <span class="o">{</span> <span class="o">}</span>
</code></pre></div></div>

<p>Annotation Attribute 값을 주입하기 위해서는 직접 주입이 불가능하고, Proxy 패턴을 활용하여
Invocation 처리하는 것이 필요하다. 이를 위한 코드는 아래와 같다.</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">EntWrapperService</span> <span class="n">annotation</span> <span class="o">=</span> <span class="n">bean</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getAnnotation</span><span class="o">(</span><span class="nc">EntWrapperService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

<span class="nc">InvocationHandler</span> <span class="n">invocationHandler</span> <span class="o">=</span> <span class="nc">Proxy</span><span class="o">.</span><span class="na">getInvocationHandler</span><span class="o">(</span><span class="n">annotation</span><span class="o">);</span>
<span class="nc">Field</span> <span class="n">f</span> <span class="o">=</span> <span class="n">invocationHandler</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"memberValues"</span><span class="o">);</span>
<span class="n">f</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
<span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">values</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;)</span> <span class="n">f</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">invocationHandler</span><span class="o">);</span>
<span class="nc">String</span> <span class="n">newValue</span> <span class="o">=</span> <span class="s">"newValue"</span><span class="o">;</span>
<span class="n">values</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"baseUrl"</span><span class="o">,</span> <span class="n">newValue</span><span class="o">);</span>
</code></pre></div></div>

<p>Proxy.getInvocationHandler() 를 통해 값을 변경하려는 대상 Object에 대한 InvocationHandler를 생성한다. 
이후 생성된 InvocationHandler를 값을 변경하면 되는데, Annotation 타입의 경우 Attribute 값이 Map&lt;String, Object&gt; 형식의
memberValues 필드에 값이 저장되어 있다. 따라서 해당 필드를 가져와 값을 변경하여 주면 원본 Instance의 값이 변경된다.
이는 JDK에서 제공하는 Proxy 클래스를 통해서 원본 객체를 바꿔주는 방식이다. JDK는 이러한 과정을 Proxy 클래스를 통한 Proxy 패턴을 구현하여 준다.
추가적으로 설명을 하자면, Proxy.getInvocationHandler()를 통해 생성된 InvocationHandler를 활용하면, 기존에 선언된
Method의 동작에 추가 동작을 주입하는 것도 가능하다. 이 부분에 대해서는 기회가 되면 포스팅 하도록 하겠다.</p>

<p>이번 작업에서는 새로 주입된 Annotation Attribute 값을 상위 클래스인 BaseWrapper에서 사용해야 하는 경우였다.
BaseWrapper의 경우에는 Bean 형식이 아니기 때문에 직접 생성자를 지정해야하는데 BeanPostProcessor를 통해 Annotation Attribute 값을
주입하다보니, BaseWrapper의 생성 시기와 Annotation Attribute 값이 주입되는 시기가 어긋나는 경우가 발생하였다.
이를 위해서 Annotation Attribute 값 주입이 끝난 후 Reflection을 통해 직접 상위 클래스의 init() Method를 직접 호출하는 방식을
적용하였다. 단, 무분별한 호출을 막기 위해 상위 클래스의 init() Method는 protected 로 선언하였더니 직접적인 invoke가 불가능하였다.
이를 위해 아래의 코드를 통해 private scope 의 Method의 호출에 성공할 수 있었다.</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nc">MethodHandles</span><span class="o">.</span><span class="na">privateLookupIn</span><span class="o">(</span><span class="n">bean</span><span class="o">.</span><span class="na">getClass</span><span class="o">(),</span> <span class="nc">MethodHandles</span><span class="o">.</span><span class="na">lookup</span><span class="o">())</span>
    <span class="o">.</span><span class="na">in</span><span class="o">(</span><span class="n">bean</span><span class="o">.</span><span class="na">getClass</span><span class="o">())</span>
    <span class="o">.</span><span class="na">findSpecial</span><span class="o">(</span><span class="nc">BaseWrapper</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="s">"init"</span><span class="o">,</span>
        <span class="nc">MethodType</span><span class="o">.</span><span class="na">methodType</span><span class="o">(</span><span class="kt">void</span><span class="o">.</span><span class="na">class</span><span class="o">),</span> <span class="n">bean</span><span class="o">.</span><span class="na">getClass</span><span class="o">())</span>
    <span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">bean</span><span class="o">);</span>
</code></pre></div></div>
<p>이와 같은 코드를 활용하면 마치 상속 받은 클래스에서 상위 클래스의 Method를 호출하는 것과 같은 효과를 볼 수 있다.</p>

        

        
        <span class="page-divider" style="margin-top: 50px;">
          <span class="one"></span>
          <span class="two"></span>
        </span>
        <table class="page__meta__additional">
          
          
          <tr>
            <th>참고자료</th>
            <td>
              <ul>
                
                
                <li><a href="https://www.programmersought.com/article/60431768611/" target="_blank">https://www.programmersought.com/article/60431768611/</a></li>
                
                
              </ul>
            </td>
          </tr>
          
        </table>
        

      </section>

      

      
  <nav class="pagination">
    
      <a href="/blog/spring/SpringIoC/" class="pagination--pager" title="Spring Framework IoC, DI란
">< PREVIOUS POST</a>
    
    
      <a href="#" class="pagination--pager disabled">NEXT POST ></a>
    
  </nav>

    </div>

    
      <div class="page__comments">
  
  
      <h4 class="page__comments-title">댓글 남기기</h4>
      <section id="utterances-comments"></section>
    
</div>

    
  </article>

  
  
    
      <div class="page__related no-author">
    
    <!--<div class="page__related">-->
      <h4 class="page__related-title">참고</h4>
      <div class="grid__wrapper">
        
          
  
    
  




<div class="grid__item">

    
    <article class="archive__item no-margin" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h3 class="archive__item-title" itemprop="headline">
      
        <a href="/blog/spring/SpringIoC/" rel="permalink">Spring Framework IoC, DI란
</a>
      
    </h3>
    
    <p class="page__meta">
        <i class="far fa-clock" aria-hidden="true"></i> 2020/12/10
    </p>
    
    <p class="archive__item-excerpt" itemprop="description">Spring 을 사용하다보면 필연적으로 IoC와 DI란 용어를 접하게 된다. 
그러나 IoC와 DI를 제대로 이해하고 사용하는가에 대해 물어본다면 사실 그렇지 않다라고 대부분의 개발자는 이야기할 것이다.
본 포스트에서는 이러한 Spring 의 IoC와 DI의 개념과 동작방식을 설명...</p>
    
    
    
    <a href="/blog/tag/spring" class="page__meta__tag">#Spring</a>
    
    
    
    <a href="/blog/tag/ioc" class="page__meta__tag">#IoC</a>
    
    
    
    <a href="/blog/tag/di" class="page__meta__tag">#DI</a>
    
  </article>
</div>

        
          
  
    
  




<div class="grid__item">

    
    <article class="archive__item no-margin" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h3 class="archive__item-title" itemprop="headline">
      
        <a href="/blog/http/Cache-Control/" rel="permalink">Cache-Control에 대하여
</a>
      
    </h3>
    
    <p class="page__meta">
        <i class="far fa-clock" aria-hidden="true"></i> 2020/12/10
    </p>
    
    <p class="archive__item-excerpt" itemprop="description">어플리케이션을 개발하다보면 성능이 중요한 경우가 많다. 성능을 개선하기 위해서는 다양한 방법이 존재하는데,
그 중 가장 쉽게 적용할 수 있으며, 효율이 높은 방법 중에 하나는 캐시(Cache)일 것이다.
</p>
    
    
    
    <a href="/blog/tag/http" class="page__meta__tag">#HTTP</a>
    
    
    
    <a href="/blog/tag/cache" class="page__meta__tag">#Cache</a>
    
  </article>
</div>

        
          
  
    
  




<div class="grid__item">

    
    <article class="archive__item no-margin" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h3 class="archive__item-title" itemprop="headline">
      
        <a href="/blog/jdk/java-hashmap/" rel="permalink">Java HashMap 동작 원리
</a>
      
    </h3>
    
    <p class="page__meta">
        <i class="far fa-clock" aria-hidden="true"></i> 2020/11/10
    </p>
    
    <p class="archive__item-excerpt" itemprop="description">Java를 통해 개발을 할 경우 HashMap을 자주 사용하게 된다. 이에 HashMap의 동작 원리 및 Hash 충돌해결에 대해 정리할 에정이다.
</p>
    
    
    
    <a href="/blog/tag/java" class="page__meta__tag">#Java</a>
    
  </article>
</div>

        
          
  
    
  




<div class="grid__item">

    
    <article class="archive__item no-margin" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h3 class="archive__item-title" itemprop="headline">
      
        <a href="/blog/server-side/java-enum-functional/" rel="permalink">enum 보다 잘 활용하기
</a>
      
    </h3>
    
    <p class="page__meta">
        <i class="far fa-clock" aria-hidden="true"></i> 2020/09/03
    </p>
    
    <p class="archive__item-excerpt" itemprop="description">개발을 진행하다보면, 정해진 코드 값이나 패턴 등 정형화된 케이스에 대한 처리가 이루어지는 경우가 많다.
이러한 경우 보통 enum을 활용하는데, 이번 포스트는 이번에 알게되었고, 사용한 enum의 활용법에 이야기 해보려 한다.
</p>
    
    
    
    <a href="/blog/tag/java" class="page__meta__tag">#Java</a>
    
  </article>
</div>

        
      </div>
    </div>
  
  
</div>
    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="검색어를 입력하세요..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow" style="display: inline-block">
  <ul class="social-icons">
    
      <li><strong>팔로우:</strong></li>
    

    
      
        
      
        
      
        
          <li><a href="https://github.com/ysjee141" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
        
      
        
      
        
      
        
          <li><a href="https://instagram.com/ysjee141" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-instagram" aria-hidden="true"></i> Instagram</a></li>
        
      
    

    <li><a href="/blog/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> 피드</a></li>
  </ul>
</div>

<div class="page__footer-copyright" style="display: inline-block">&copy; 2021 HAPPL. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/blog/assets/js/main.min.js"></script>




<script src="/blog/assets/js/lunr/lunr.min.js"></script>
<script src="/blog/assets/js/lunr/lunr-store.js"></script>
<script src="/blog/assets/js/lunr/lunr-en.js"></script>



<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-162766344-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-162766344-1');
</script>


    <style>
    .utterances {
        width: 100%;
        max-width: none;
    }
</style>
<script>
  'use strict';

  (function() {
    var commentContainer = document.querySelector('#utterances-comments');

    if (!commentContainer) {
      return;
    }

    var script = document.createElement('script');
    script.setAttribute('src', 'https://utteranc.es/client.js');
    script.setAttribute('repo', 'ysjee141/blog');
    script.setAttribute('issue-term', 'pathname');
    script.setAttribute('theme', 'github-light');
    script.setAttribute('crossorigin', 'anonymous');

    commentContainer.appendChild(script);
  })();
</script>

  



<script src="/blog/assets/js/_extend.js"></script>
<script src="/blog/assets/js/vendor/mermaid.min.js"></script>
<script>
  mermaid.initialize({
    startOnLoad:true,
    theme: "forest",
    fontFamily: "D2Coding"
  });
  mermaid.init(undefined, '.language-mermaid');
</script>

  </body>
</html>
